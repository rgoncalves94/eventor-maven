<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
		xmlns:f="http://java.sun.com/jsf/core"
		xmlns:h="http://java.sun.com/jsf/html"
		xmlns:p="http://primefaces.org/ui"
		xmlns:ui="http://java.sun.com/jsf/facelets">
    <h:body>
 
    	<ui:composition template="/WEB-INF/templates/layout.xhtml">
 
    		<ui:define name="content">
    			<div class="row">
    				<div class="col-sm-12">
   						<h:form enctype="multipart/form-data">
   							<p:growl id="growl" life="2000" />
   							<h2><span class="fa fa-calendar"></span> Novo Evento</h2>
   							<p:messages id="msgs" />
   							<div class="row">
	   							<div class="col-sm-6 ui-md-6">
		   							<div class="form-group">
		   								<label for="">Titulo do Evento:</label><br />
		   								<p:inputText required="true" label="Titulo do Evento" value="#{eventoMB.evento.titulo}" />
		   							</div>
	   							</div>
	   							<div class="col-sm-6 ui-md-6">
		   							<div class="form-group">
		   								<label for="">Nome do Organizador:</label><br />
		   								<p:inputText required="true" label="Nome do Organizador" value="#{eventoMB.evento.nomeOrganizador}" />
		   							</div>
	   							</div>
   							</div>
   							
   							<h3><span class="fa fa-calendar"></span> Dados de Localização</h3>
   							<div class="row">
	   							<div class="col-sm-3 ui-md-3">
	   								<h:inputHidden value="#{eventoMB.evento.localizacao.id}"/>
		  							<div class="form-group">
		  								<label for="">CEP:</label><br />
		  								<p:inputMask required="true" label="CEP" class="cep" value="#{eventoMB.evento.localizacao.cep}" mask="99999-999"/>
		  							</div>
	   							</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">Logradouro:</label><br />
		   								<p:inputText required="true" label="logradouro" class="logradouro" value="#{eventoMB.evento.localizacao.logradouro}" />
		   							</div>
	   							</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">Bairro:</label><br />
		   								<p:inputText required="true" label="Bairro" class="bairro" value="#{eventoMB.evento.localizacao.bairro}" />
		   							</div>
		   						</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">Cidade:</label><br />
		   								<p:inputText required="true" label="cidade" class="cidade" value="#{eventoMB.evento.localizacao.cidade}" />
		   							</div>
		   						</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">UF:</label><br />
		   								<p:inputText placeholder="Ex: SP" label="UF" required="true" class="uf" value="#{eventoMB.evento.localizacao.uf}" />
		   							</div>
		   						</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">Número:</label><br />
		   								<p:inputText required="true" label="Numero" class="numero" value="#{eventoMB.evento.localizacao.numero}" />
		   							</div>
		   						</div>
	   							<div class="col-sm-3 ui-md-3">
		   							<div class="form-group">
		   								<label for="">Complemento:</label><br />
		   								<p:inputText class="complemento" value="#{eventoMB.evento.localizacao.complemento}" />
		   							</div>
		   						</div>
		   					</div>

   							<h3><span class="fa fa-calendar"></span> Data de Acontecimento</h3>
   							<div class="row">
	   							<div class="col-sm-6 ui-md-6">
		   							<div class="form-group">
		   								<label for="">Data de Início:</label><br />
		   								<p:calendar required="true" label="Data Inicio" class="datetime" value="#{eventoMB.evento.inicio}" pattern="dd/MM/yyyy HH:mm:ss" />
		   							</div>
	   							</div>
	   							<div class="col-sm-6 ui-md-6">
		   							<div class="form-group">
		   								<label for="">Data de Término:</label><br />
		   								<p:calendar label="Data Termino" required="true" class="datetime" value="#{eventoMB.evento.termino}" pattern="dd/MM/yyyy HH:mm:ss" />
		   							</div>
	   							</div>
	   						</div>
   							
   							<div class="row">
   								<div class="col-sm-12 ui-md-12">
	   								<div class="form-group">
		   								<label for="">Descrição: </label><br />
		   								<p:textEditor label="Descricao" required="true"
		   								 widgetVar="editor1" value="#{eventoMB.evento.descricao}" height="300" style="margin-bottom:10px"/>
		   							</div>
	   							</div>
   							</div>
   							
   							<p:commandButton ajax="false" value="Salvar Evento" update="growl" icon="ui-icon-disk" actionListener="#{eventoMB.salva}" styleClass="ui-priority-primary" />
							<p:button outcome="home.xhtml" value="Voltar para a listagem"></p:button>
   							
   							<h2><span class="fa fa-ticket"></span> Ingressos</h2>
   							
   							<div class="row">
   								<div class="col-sm-12 ui-md-12">
	   								<p:dataTable var="ingresso" value="#{eventoMB.evento.ingressos}">
								        <f:facet name="header">
								            Ingressos
								        </f:facet>
								        <p:columnGroup type="header">
								            <p:row>
								                <p:column headerText="ID" />
								                <p:column headerText="Nome" />
								                <p:column headerText="Valor" />
								                <p:column headerText="Ações" />
								            </p:row>
								        </p:columnGroup>
								 
								        <p:column>
								            <h:outputText value="#{ingresso.id}" />
								        </p:column>
								        <p:column>
								            <h:outputText value="#{ingresso.descricao}" />
								        </p:column>
								        <p:column>
								            <h:outputText value="#{ingresso.valor}" />
								        </p:column>
								        <p:column>
								        	<button type="button" data-ref="#{ingresso.id}" class=" remove-ingresso btn btn-danger" value="remove" >
								        		<i class="fa fa-times"></i> Remove
								        	</button>
								        </p:column>
								    </p:dataTable>
								</div>
							    <div class="col-sm-6 ui-md-6 form-group">
							    	<label for="">Nome do ingresso:</label>
							    	<p:inputText value="#{eventoMB.ingresso.descricao}" />
							    </div>
							    <div class="col-sm-6 ui-md-6 form-group">
							    	<label for="">Valor do ingresso:</label>
								    <p:inputNumber value="#{eventoMB.ingresso.valor}" symbol="R$" symbolPosition="p" 
	                             								decimalSeparator="," thousandSeparator="."></p:inputNumber>
	                            </div>
   							</div>
   							
   							<p:commandButton ajax="false" value="Salvar Ingresso e Evento" update="growl" actionListener="#{eventoMB.salva}" icon="ui-icon-disk" styleClass="ui-priority-primary" />
							<p:button outcome="home.xhtml" value="Voltar para a listagem"></p:button>
   						</h:form>
   					</div>
   				</div>
   				<script type="text/javascript">
   					$(document).ready(function() {
   	   					$('.cep').on('blur', function() {
   	   	   					if(!/^[0-9]{5}-?[0-9]{3}$/.test($('.cep').val()))
   	   	   	   					return ;
							$.ajax({
								'url': 'https://viacep.com.br/ws/' + $('.cep').val().replace(/\-/, "") + '/json/',
								'dataType': 'json'
							}).done(function(json){
								$(".logradouro").val(json.logradouro);
								$(".complemento").val(json.complemento);
								$(".bairro").val(json.bairro);
								$(".cidade").val(json.localidade);
								$(".uf").val(json.uf);
							});
   	   					});

   	   					$('.remove-ingresso').on('click', function() {
							var ref = $(this).attr('data-ref');

							if(ref == null || ref == undefined) {
								alert('falha ao remover, tente novamente mais tarde');
								return ;
							}
   	   	   					
							$.ajax({
								'url': 'evento/remove',
								'dataType': 'json',
								'type': 'post',
								'data': {ref:ref}
							}).done(function(json){
								console.log(321);
								if(json.success != undefined) {

									$.confirm({
									    title: 'Ingresso removido',
									    content: json.success + " Sua página sera recarregada" ,
									    type:"green",
									    buttons: {
									        confirmar: {
									            text: 'OK',
									            btnClass: 'btn-blue',
									            keys: ['enter'],
									            action: function(){
									            	window.location = "novo-evento.xhtml";
									            }
									        }
									    }
									});
									
									return ;
								}
								
								$.alert({title:"Erro", content:"Falha ao excluir o ingresso", type:'red'});
							}).fail(function(error) {
								$.alert({title:"Erro", content:"Falha ao excluir o ingresso", type:'red'});
							});
	   					});
   	   				});
   				</script>
    		</ui:define>
 
    	</ui:composition>
 
    </h:body>
 
</html>